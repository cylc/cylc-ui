<!--
Copyright (C) NIWA & British Crown (Met Office) & Contributors.

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->

<template>
  <div>
    <!-- dropdown menu -->
    <v-menu
      offset-y
      content-class="c-mutation-menu"
      v-model="showMenu"
      :position-x="x"
      :position-y="y"
      @show-mutations-menu="showMutationsMenu"
      :disabled="!interactive"
      :close-on-content-click="false"
      :close-on-click="false"
      v-click-outside="{ handler: onClickOutside, include: clickOutsideInclude }"
      max-height="90vh"
      dark
    >
      <!-- NOTE: because the `attach` prop is not true, the actual DOM element
      containing the stuff below is not the `.v-menu` div, but a completely
      separate `.v-menu__content` div created by vuetify
      (the `.v-menu` div is actually empty). -->
      <v-card
        ref="menuContent"
        v-if="node"
      >
        <v-card-title class="text-h6">
          {{ node.id }}
        </v-card-title>
        <v-card-subtitle>
          {{ typeAndStatusText }}
        </v-card-subtitle>
        <v-divider v-if="primaryMutations.length || displayMutations.length" />
        <v-skeleton-loader
          v-if="isLoadingMutations && primaryMutations.length"
          type="list-item-avatar-two-line@3"
          min-width="400"
        >
        </v-skeleton-loader>
        <v-list
          v-if="displayMutations.length"
          class="c-mutation-menu-list"
        >
          <v-list-item
            v-for="{ mutation, requiresInfo, authorised } in displayMutations"
            :key="mutation.name"
            :disabled=!authorised
            @click.stop="enact(mutation, requiresInfo)"
            class="c-mutation"
          >
            <v-list-item-avatar>
              <v-icon :disabled=!authorised large>{{ mutation._icon }}</v-icon>
            </v-list-item-avatar>
            <v-list-item-content>
              <v-list-item-title>{{ mutation._title }}</v-list-item-title>
              <!--
              don't use v-list-item-description here, vuetify will standardise
              line heights and cuts off text that overspills this way we can
              have the required number of lines of text.
              -->
              <span class="c-description">{{ mutation._shortDescription }}</span>
            </v-list-item-content>
            <v-list-item-action>
              <v-btn
                icon
                :disabled=!authorised
                x-large
                class="float-right"
                @click.stop="openDialog(mutation)"
                data-cy="mutation-edit"
              >
                <v-icon>{{ icons.pencil }}</v-icon>
              </v-btn>
            </v-list-item-action>
          </v-list-item>
          <v-list-item
            v-if="canExpand"
          >
            <v-list-item-content
              @click="expandCollapse"
              @click.stop.prevent
            >
              <v-btn id="less-more-button"
                rounded
              >
                {{ expanded ? 'See Less' : 'See More' }}
              </v-btn>
            </v-list-item-content>
          </v-list-item>
        </v-list>
      </v-card>
    </v-menu>
    <v-dialog
      v-model="dialog"
      max-width="700px"
      content-class="c-mutation-dialog"
      v-if="dialogMutation"
    >
      <Mutation
        :mutation="dialogMutation"
        :cylcObject="node"
        :initialData="initialData(dialogMutation, node.tokens)"
        :cancel="closeDialog"
        :types="types"
        :key="dialogKey /* Enables re-render of component each time dialog opened */"
        ref="mutationComponent"
      />
    </v-dialog>
  </div>
</template>

<script>
import {
  filterAssociations,
  getMutationArgsFromTokens,
  mutate
} from '@/utils/aotf'
import Mutation from '@/components/cylc/Mutation'
import {
  mdiPencil
} from '@mdi/js'
import { mapState } from 'vuex'

export default {
  name: 'CylcObjectMenu',

  components: {
    Mutation
  },

  props: {
    interactive: {
      type: Boolean,
      required: false,
      default: true
    }
  },

  data () {
    return {
      dialog: false,
      dialogMutation: null,
      dialogKey: false,
      expanded: false,
      node: null,
      mutations: [],
      isLoadingMutations: true,
      showMenu: false,
      types: [],
      x: 0,
      y: 0,
      icons: {
        pencil: mdiPencil
      }
    }
  },

  mounted () {
    this.$eventBus.on('show-mutations-menu', this.showMutationsMenu)
  },

  beforeDestroy () {
    this.$eventBus.off('show-mutations-menu', this.showMutationsMenu)
  },

  computed: {
    primaryMutations () {
      return this.$workflowService.primaryMutations[this.node.type] || []
    },
    canExpand () {
      return this.primaryMutations.length && this.mutations.length > this.primaryMutations.length
    },
    ...mapState('user', ['user']),
    displayMutations () {
      if (!this.mutations.length || this.user.permissions.length < 2) {
        return []
      }
      const shortList = this.primaryMutations
      if (!this.expanded && shortList.length) {
        return this.mutations.filter(
          x => shortList.includes(x.mutation.name)
        ).sort(
          (x, y) => shortList.indexOf(x.mutation.name) - shortList.indexOf(y.mutation.name)
        )
      }
      return this.mutations
    },
    typeAndStatusText () {
      if (!this.node) {
        // can happen briefly when switching workflows
        return
      }
      let ret = this.node.type
      if (this.node.type !== 'cycle') {
        // NOTE: cycle point nodes don't have associated node data at present
        ret += ' - '
        if (this.node.type === 'workflow') {
          ret += this.node.node.statusMsg || 'state unknown'
        } else {
          ret += this.node.node.state || 'state unknown'
          if (this.node.node.isHeld) {
            ret += ' (held)'
          }
          if (this.node.node.isQueued) {
            ret += ' (queued)'
          }
          if (this.node.node.isRunahead) {
            ret += ' (runahead)'
          }
        }
      }
      return ret
    }
  },

  methods: {
    openDialog (mutation) {
      this.dialog = true
      this.dialogMutation = mutation
      // Tell Vue to re-render the dialog component:
      this.dialogKey = !this.dialogKey
    },

    closeDialog () {
      this.dialog = false
      this.dialogMutation = null
    },

    /**
     * Handler for clicking outside menu (close it).
     *
     * We override vuetify default handling because we don't want to
     * close when clicking on another cylc object.
     *
     * @param {Event} e - the click event
     */
    onClickOutside (e) {
      this.showMenu = false
      this.expanded = false
      if (e.target?.classList.contains('c-interactive')) {
        this.$nextTick(() => {
          // Wait until next tick so that the menu briefly closes + reopens
          // giving more indication to user that it has changed
          this.showMenu = true
        })
      }
    },

    /**
     * Return array of elements that count as "inside" for the
     * close-on-click-outside functionality.
     *
     * @returns {Array<HTMLElement>}
     */
    clickOutsideInclude () {
      // Need this to tell vuetify what the actual content DOM element is
      // instead of the empty `this.$el` (see note at top).
      const el = this.$refs.menuContent?.$el
      // (Return empty array if element not yet loaded)
      return el ? [el] : []
    },

    expandCollapse () {
      this.expanded = !this.expanded
      this.$nextTick(() => {
        // If expanding menu causes it overflow off screen, move it into view
        // (This would happen automatically, but it's too slow -
        // see https://github.com/cylc/cylc-ui/issues/1163)
        if (this.y + this.$refs.menuContent.$el.clientHeight > document.body.clientHeight) {
          this.y = document.body.clientHeight - this.$refs.menuContent.$el.clientHeight - 5
        }
      })
    },

    /* Call a mutation using only the tokens for args. */
    callMutationFromContext (mutation) {
      // eslint-disable-next-line no-console
      console.debug(`mutation: ${mutation._title} ${this.node.id}`)
      mutate(
        mutation,
        getMutationArgsFromTokens(mutation, this.node.tokens),
        this.$workflowService.apolloClient
      )
      this.showMenu = false
    },

    showMutationsMenu ({ node, event }) {
      this.node = node
      this.x = event.clientX
      this.y = event.clientY
      // await graphql query to get mutations
      this.$workflowService.introspection.then(({ mutations, types }) => {
        // if mutations are slow to load then there will be a delay before they are reactively
        // displayed in the menu (this is what the skeleton-loader is for)
        this.isLoadingMutations = false
        this.types = types
        let type = this.node.type
        if (type === 'family') {
          // show the same mutation list for families as for tasks
          type = 'task'
        }
        this.mutations = filterAssociations(
          type,
          this.node.tokens,
          mutations,
          this.user.permissions
        ).sort(
          (a, b) => a.mutation.name.localeCompare(b.mutation.name)
        )
      })
      this.showMenu = true
    },

    initialData (mutation, tokens) {
      return getMutationArgsFromTokens(mutation, tokens)
    },

    enact (mutation, requiresInfo) {
      if (requiresInfo) {
        this.openDialog(mutation)
      } else {
        this.callMutationFromContext(mutation)
      }
    }
  }
}
</script>
